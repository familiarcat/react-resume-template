# AWS Amplify Next.js Deployment Guide

This guide provides instructions for deploying a Next.js application to AWS Amplify using a static export approach with the necessary server files to satisfy Amplify's requirements.

## The Problem

AWS Amplify expects certain files to be present in the build output directory, including `required-server-files.json`, which is generated by Next.js when using server-side rendering. When using static export (`output: 'export'`), Next.js doesn't generate this file, causing Amplify to fail with the error:

```
[ERROR]: !!! CustomerError: Can't find required-server-files.json in build output directory
```

## The Solution

Our solution is to:

1. Build the application as a static site using Next.js's static export feature
2. Create a dummy `required-server-files.json` file in the `.next` directory
3. Copy all static files from the `out` directory to `.next/static`
4. Set the `baseDirectory` in the amplify.yml file to `.next`

This approach allows AWS Amplify to find the required server files while still serving a static site.

## Configuration Files

### amplify.yml

```yaml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - npm run amplify:build:dummy
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
```

### next.config.js

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',
  images: {
    unoptimized: true,
  },
};

module.exports = nextConfig;
```

## Build Script

The build script (`scripts/amplify-build-with-dummy.js`) performs the following steps:

1. Creates a static export configuration in next.config.js
2. Builds the Next.js application with static export
3. Creates a dummy `required-server-files.json` file in the `.next` directory
4. Creates a dummy `routes-manifest.json` file in the `.next` directory
5. Copies all static files from the `out` directory to `.next/static`
6. Copies the public directory to `.next/public`
7. Copies next.config.js and package.json to `.next`

## Deployment Steps

### 1. Push Your Code to a Git Repository

Make sure your code is pushed to a Git repository (GitHub, BitBucket, GitLab, etc.).

### 2. Create a New AWS Amplify App

1. Log in to the [AWS Amplify Console](https://console.aws.amazon.com/amplify/home)
2. Click "New app" > "Host web app"
3. Choose your Git provider and connect your repository
4. Select the branch you want to deploy

### 3. Configure the Build Settings

The default build settings should work, but you can verify them:

1. In the "Build settings" section, make sure the build specification is set to use `amplify.yml`
2. The build commands should be:
   - **preBuild**: `npm ci`
   - **build**: `npm run amplify:build:dummy`
3. The artifacts should be:
   - **baseDirectory**: `.next`
   - **files**: `**/*`

### 4. Deploy the App

1. Click "Save and deploy"
2. Wait for the build and deployment to complete
3. Once deployed, you can access your app at the provided URL

## How It Works

This deployment uses a hybrid approach:

1. **Static Export**: The application is built as a static site using Next.js's static export feature, which generates the site in the `out` directory.

2. **Dummy Server Files**: The build script creates dummy server files in the `.next` directory to satisfy Amplify's requirements.

3. **File Copying**: All static files from the `out` directory are copied to `.next/static` to ensure they're included in the deployment.

4. **Base Directory**: The `baseDirectory` in the amplify.yml file is set to `.next` to ensure Amplify can find the required server files.

## Testing Locally

To test this approach locally:

1. Run the dummy build script:
   ```bash
   npm run amplify:build:dummy
   ```

2. Check that the `.next` directory contains the required server files and the static files from the `out` directory.

3. Serve the static files:
   ```bash
   npx serve .next/static
   ```

4. Open `http://localhost:3000` in your browser to verify that the site works correctly.

## Troubleshooting

If you encounter issues during deployment:

1. **Check the build logs** for errors
2. **Verify that the dummy files are created** in the `.next` directory
3. **Make sure the static files are copied** to `.next/static`
4. **Check that the `baseDirectory` is set to `.next`** in the amplify.yml file

## Limitations

This approach has the same limitations as static export:

1. **No Server-Side Rendering (SSR)**
2. **No API Routes**
3. **No Server Components**
4. **No Incremental Static Regeneration (ISR)**

However, it allows you to deploy a static site to AWS Amplify without the need for server-side rendering, which is a common requirement for many applications.

## Additional Resources

- [Next.js Static Export Documentation](https://nextjs.org/docs/pages/building-your-application/deploying/static-exports)
- [AWS Amplify Documentation](https://docs.aws.amazon.com/amplify/latest/userguide/welcome.html)
- [AWS Amplify Hosting Documentation](https://docs.aws.amazon.com/amplify/latest/userguide/welcome.html)
- [AWS Amplify Troubleshooting](https://docs.aws.amazon.com/amplify/latest/userguide/troubleshooting-ssr-deployment.html)
